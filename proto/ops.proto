syntax = "proto3";

package stepir;

import "datatype.proto";
import "func.proto";

message Operation {
  string name = 1;
  uint64 id = 2;
  reserved 3 to 10;
  Sim a = 11;
  optional Sim b = 12;
  reserved 13 to 20;
  oneof op {
    Input input = 21;
    // reserved 22 to 24;
    Map map = 25;
    // Flatmap flatmap = ;
    // Accum accum = ;
    // Scan scan = ;
    // FnBlock fn_block = ;

    Zip zip = 31;
    Unzip unzip = 32;
    Broadcast broadcast = 33;
    // RepeatRef repeat_ref = ;
    // RepeatN repeat_n = ;
    // RepeatStatic repeat_static = ;
    // Bufferize bufferize = ;
    // Promote promote = ;
    // Reshape reshape = ;
    // Flatten flatten = ;
    // Enumerate enumerate = ;
    Partition flat_partition = 45;
    Reassemble flat_reassemble = 46;    
    // reserved 47 to 50?
    Output output = 51;
  }
}

message Output {
  uint64 node_id = 1;
  optional uint64 stream_idx = 2;
}

message Input {
}

message Map {
  uint64 node_id = 1;
  optional uint64 stream_idx = 2;
  ElemtoElemFunc func = 3;
}

message Broadcast {
  uint64 node_id = 1;
  optional uint64 stream_idx = 2;
  repeated uint64 out_stream_idxes = 3;
}

message Partition {
  uint64 node_id_data = 1;
  optional uint64 stream_idx_data = 2;
  uint64 node_id_control = 3;
  optional uint64 stream_idx_control = 4;
  repeated uint64 out_stream_idxes = 5;
}
  
message Reassemble {
  message Stream {
    uint64 node_id = 1;
    optional uint64 stream_idx = 2;
  }
  Stream node_id_data = 1;
  uint64 node_id_control = 2;
  optional uint64 stream_idx_control = 3;
}

message Zip {
  uint64 node_id_a = 1;
  optional uint64 stream_idx_a = 2;
  uint64 node_id_b = 3;
  optional uint64 stream_idx_b = 4;
}

message Unzip {
  uint64 node_id = 1;
  optional uint64 stream_idx = 2;
  repeated uint64 idxes = 3;
}
