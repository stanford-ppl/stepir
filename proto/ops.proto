syntax = "proto3";

package stepir;

// import "func.proto"
import "datatype.proto";

message Operation {
  string name = 1;
  uint64 id = 2;
  ChannelInfo channel_info = 3;
  reserved 4 to 10;
  oneof op {
    Input input = 11;
    Map map = 12;
    // Flatmap flatmap = 13;
    // Accum accum = 14;
    // Scan scan = 17;
    Zip zip = 15;
    // Unzip unzip = 16;
    // Broadcast broadcast = 26;
    // Enumerate enumerate = 18;
    // RepeatRef repeat_ref = 19;
    // RepeatN repeat_n = 20;
    // Bufferize bufferize = 21;
    // Promote promote = 22;
    // Reshape reshape = 23;
    // Flatten flatten = 24;
    // FlatPartition flat_partition = 25;
    // FlatReassemble flat_reassemble = 26;    
    // FnBlock fn_block = 27;
    // // reserved 28 to 35?
    // RepeatStatic repeat_static = 28;
    Output output = 30;
  }
}


message ChannelInfo {
  message BaseAChannel {
    uint64 in_id = 2;
    uint64 curr_id = 3;
  }
  message InputChannel {
    uint64 curr_id = 2;
  }
  message OutputChannel {
    uint64 in_id = 2;
  }
  message BroadcastChannel {
    uint64 in_id = 3;
    repeated uint64 curr_ids = 4;
  }

  message BaseBChannel {
    uint64 in_id = 1;
    uint64 curr_id = 2;
  }
  message PartitionChannel {
    uint64 a_in_id = 1;
    uint64 b_in_id = 2;
    repeated uint64 curr_ids = 3;
  }
  message ReassembleChannel {
    repeated uint64 a_in_ids = 1;
    uint64 b_in_id = 2;
    uint64 curr_id = 3;
  }
  message ZipChannel {
    uint64 a_in_id = 1;
    uint64 b_in_id = 2;
    uint64 curr_id = 3;
  }
  message UnzipChannel {
    uint64 in_id = 1;
    uint64 a_curr_id = 2;
    uint64 b_curr_id = 3;
  }
  message ChannelB {
    Sim b = 1;
    oneof chan_type_b {
      BaseBChannel base_b = 2;
      PartitionChannel partition = 3;
      ReassembleChannel reassemble = 4;
      ZipChannel zip = 5;
      UnzipChannel unzip = 6;
    }
  }
  Sim a = 1;
  oneof chan_type_a {
    BaseAChannel base_a = 2;
    InputChannel input = 3;
    OutputChannel output = 4;
    BroadcastChannel broadcast = 5;
    ChannelB channel_b = 6;
  }
}

message Stream { // corresponds to StreamNode
  uint64 id = 1;
  optional uint64 idx = 2;
}

message Input {
}

message Output {
}

message Zip {
}

/*
message FlatReassemble {
    string label = 1;
    uint64 id = 2;
    repeated uint64 streams = 3;
}
*/

message Map {
  string label = 1;
  uint64 id = 2;
}